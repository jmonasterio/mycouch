============================= test session starts =============================
platform win32 -- Python 3.13.9, pytest-7.4.3, pluggy-1.6.0 -- C:\github\mycouch\.venv\Scripts\python.exe
cachedir: .pytest_cache
rootdir: c:\github\roady-amp\mycouch
configfile: pytest.ini
plugins: anyio-4.11.0, asyncio-0.21.1, cov-4.1.0
asyncio: mode=Mode.STRICT
collecting ... collected 264 items

tests/test_admin_tenant_protection.py::TestAdminTenantProtection::test_blocks_direct_delete PASSED [  0%]
tests/test_admin_tenant_protection.py::TestAdminTenantProtection::test_blocks_put_soft_delete PASSED [  0%]
tests/test_admin_tenant_protection.py::TestAdminTenantProtection::test_blocks_put_hard_delete PASSED [  1%]
tests/test_admin_tenant_protection.py::TestAdminTenantProtection::test_blocks_bulk_delete PASSED [  1%]
tests/test_admin_tenant_protection.py::TestAdminTenantProtection::test_allows_normal_update PASSED [  1%]
tests/test_clerk_service.py::TestClerkService::test_clerk_service_initialization PASSED [  2%]
tests/test_clerk_service.py::TestClerkService::test_clerk_service_missing_issuer_url PASSED [  2%]
tests/test_clerk_service.py::TestClerkService::test_clerk_service_no_api_available PASSED [  3%]
tests/test_clerk_service.py::TestClerkService::test_clerk_service_no_secret_key PASSED [  3%]
tests/test_clerk_service.py::TestClerkService::test_is_configured PASSED [  3%]
tests/test_clerk_service.py::TestClerkService::test_verify_session_token_no_client PASSED [  4%]
tests/test_clerk_service.py::TestClerkService::test_verify_session_token_success PASSED [  4%]
tests/test_clerk_service.py::TestClerkService::test_verify_session_token_failure PASSED [  4%]
tests/test_clerk_service.py::TestClerkService::test_get_user_session_metadata_no_client PASSED [  5%]
tests/test_clerk_service.py::TestClerkService::test_get_user_session_metadata_success PASSED [  5%]
tests/test_clerk_service.py::TestClerkService::test_get_user_session_metadata_no_metadata PASSED [  6%]
tests/test_clerk_service.py::TestClerkService::test_get_user_session_metadata_failure PASSED [  6%]
tests/test_clerk_service.py::TestClerkService::test_update_active_tenant_in_session_no_client PASSED [  6%]
tests/test_clerk_service.py::TestClerkService::test_update_active_tenant_in_session_success PASSED [  7%]
tests/test_clerk_service.py::TestClerkService::test_update_active_tenant_in_session_fallback PASSED [  7%]
tests/test_clerk_service.py::TestClerkService::test_update_active_tenant_in_session_failure PASSED [  7%]
tests/test_clerk_service.py::TestClerkService::test_get_user_active_tenant_no_client PASSED [  8%]
tests/test_clerk_service.py::TestClerkService::test_get_user_active_tenant_from_session PASSED [  8%]
tests/test_clerk_service.py::TestClerkService::test_get_user_active_tenant_fallback_to_user PASSED [  9%]
tests/test_clerk_service.py::TestClerkService::test_get_user_active_tenant_not_found PASSED [  9%]
tests/test_clerk_service.py::TestClerkService::test_get_user_active_tenant_failure PASSED [  9%]
tests/test_clerk_service.py::TestClerkService::test_update_user_active_tenant_no_client PASSED [ 10%]
tests/test_clerk_service.py::TestClerkService::test_update_user_active_tenant_success PASSED [ 10%]
tests/test_clerk_service.py::TestClerkService::test_update_user_active_tenant_no_existing_metadata PASSED [ 10%]
tests/test_clerk_service.py::TestClerkService::test_update_user_active_tenant_failure PASSED [ 11%]
tests/test_clerk_service.py::TestClerkService::test_get_user_from_jwt_success PASSED [ 11%]
tests/test_clerk_service.py::TestClerkService::test_get_user_from_jwt_invalid_token PASSED [ 12%]
tests/test_clerk_service.py::TestClerkService::test_get_user_from_jwt_missing_fields PASSED [ 12%]
tests/test_clerk_service.py::TestClerkService::test_full_workflow_session_management PASSED [ 12%]
tests/test_clerk_service.py::TestClerkServiceIntegration::test_service_without_backend_api PASSED [ 13%]
tests/test_clerk_service.py::TestClerkServiceIntegration::test_service_exception_handling PASSED [ 13%]
tests/test_couch_sitter_service.py::TestCouchSitterService::test_service_initialization PASSED [ 14%]
tests/test_couch_sitter_service.py::TestCouchSitterService::test_service_initialization_no_auth PASSED [ 14%]
tests/test_couch_sitter_service.py::TestCouchSitterService::test_hash_sub PASSED [ 14%]
tests/test_couch_sitter_service.py::TestCouchSitterService::test_find_user_by_sub_hash_not_found PASSED [ 15%]
tests/test_couch_sitter_service.py::TestCouchSitterService::test_create_user_with_personal_tenant PASSED [ 15%]
tests/test_couch_sitter_service.py::TestCouchSitterService::test_create_user_with_personal_tenant_minimal PASSED [ 15%]
tests/test_couch_sitter_service.py::TestCouchSitterService::test_ensure_user_exists_new_user PASSED [ 16%]
tests/test_couch_sitter_service.py::TestCouchSitterService::test_ensure_user_exists_existing_user_new_schema PASSED [ 16%]
tests/test_couch_sitter_service.py::TestCouchSitterService::test_ensure_app_exists_new_app PASSED [ 17%]
tests/test_couch_sitter_service.py::TestCouchSitterService::test_ensure_app_exists_existing_app PASSED [ 17%]
tests/test_couch_sitter_service.py::TestCouchSitterService::test_load_all_apps PASSED [ 17%]
tests/test_couch_sitter_service.py::TestCouchSitterService::test_get_user_tenant_info PASSED [ 18%]
tests/test_couch_sitter_service.py::TestCouchSitterService::test_get_user_tenant_info_missing_sub PASSED [ 18%]
tests/test_couch_sitter_service.py::TestCouchSitterService::test_create_user_with_personal_tenant_multi_tenant PASSED [ 18%]
tests/test_couch_sitter_service.py::TestCouchSitterService::test_ensure_personal_tenant_exists_existing PASSED [ 19%]
tests/test_couch_sitter_service.py::TestCouchSitterService::test_ensure_personal_tenant_exists_missing PASSED [ 19%]
tests/test_couch_sitter_service.py::TestCouchSitterService::test_migrate_user_to_multi_tenant PASSED [ 20%]
tests/test_couch_sitter_service.py::TestCouchSitterServiceIntegration::test_full_user_creation_workflow PASSED [ 20%]
tests/test_couch_sitter_service.py::TestCouchSitterServiceIntegration::test_user_exists_workflow PASSED [ 20%]
tests/test_couch_sitter_service.py::TestCouchSitterServiceIntegration::test_error_handling_workflow PASSED [ 21%]
tests/test_couch_sitter_service.py::TestCouchSitterServiceIntegration::test_app_management_workflow PASSED [ 21%]
tests/test_database_whitelist.py::TestDatabaseWhitelist::test_blocks_access_to_non_whitelisted_database PASSED [ 21%]
tests/test_database_whitelist.py::TestDatabaseWhitelist::test_blocks_access_to_user_database PASSED [ 22%]
tests/test_database_whitelist.py::TestDatabaseWhitelist::test_blocks_access_to_app_database PASSED [ 22%]
tests/test_database_whitelist.py::TestDatabaseWhitelist::test_allows_access_to_couch_sitter PASSED [ 23%]
tests/test_database_whitelist.py::TestDatabaseWhitelist::test_allows_access_to_roady PASSED [ 23%]
tests/test_database_whitelist.py::TestDatabaseWhitelist::test_blocks_database_creation_via_put PASSED [ 23%]
tests/test_database_whitelist.py::TestDatabaseWhitelist::test_allows_document_creation_via_put PASSED [ 24%]
tests/test_database_whitelist.py::TestDatabaseWhitelist::test_error_message_includes_allowed_databases PASSED [ 24%]
tests/test_jwt_fallback_fix.py::TestJWTFallbackRemoval::test_valid_jwt_with_tenant_claim_accepted PASSED [ 25%]
tests/test_jwt_fallback_fix.py::TestJWTFallbackRemoval::test_stale_jwt_without_tenant_claim_rejected PASSED [ 25%]
tests/test_jwt_fallback_fix.py::TestJWTFallbackRemoval::test_no_fallback_to_clerk_api PASSED [ 25%]
tests/test_jwt_fallback_fix.py::TestJWTFallbackRemoval::test_couch_sitter_requests_unaffected PASSED [ 26%]
tests/test_jwt_fallback_fix.py::TestTenantMembershipValidation::test_unauthorized_tenant_switch_blocked PASSED [ 26%]
tests/test_jwt_fallback_fix.py::TestMissingActiveClaimsErrorHandling::test_error_message_clear_and_actionable PASSED [ 26%]
tests/test_jwt_fallback_fix.py::TestMissingActiveClaimsErrorHandling::test_logging_contains_security_context PASSED [ 27%]
tests/test_jwt_fallback_fix.py::TestJWTClaimVariations::test_active_tenant_id_at_top_level PASSED [ 27%]
tests/test_jwt_fallback_fix.py::TestJWTClaimVariations::test_tenant_id_fallback_claim PASSED [ 28%]
tests/test_jwt_fallback_fix.py::TestJWTClaimVariations::test_active_tenant_in_metadata PASSED [ 28%]
tests/test_jwt_fallback_fix.py::TestJWTClaimVariations::test_all_tenant_claims_missing PASSED [ 28%]
tests/test_jwt_fallback_fix.py::TestSecurityLogging::test_missing_claim_logged_at_warning_level PASSED [ 29%]
tests/test_jwt_fallback_fix.py::TestSecurityLogging::test_user_info_in_security_log PASSED [ 29%]
tests/test_jwt_fallback_fix.py::TestComplianceWithSecurityReview::test_cwe_287_improper_authentication PASSED [ 29%]
tests/test_jwt_fallback_fix.py::TestComplianceWithSecurityReview::test_no_cross_tenant_access PASSED [ 30%]
tests/test_jwt_fallback_fix.py::TestIntegrationWithProxy::test_roady_request_rejects_missing_claim PASSED [ 30%]
tests/test_jwt_template_validation.py::TestJWTTemplateValidation::test_choose_tenant_updates_clerk_metadata SKIPPED [ 31%]
tests/test_jwt_template_validation.py::TestJWTTemplateValidation::test_unauthorized_tenant_access_blocked SKIPPED [ 31%]
tests/test_jwt_template_validation.py::TestJWTTemplateValidation::test_missing_tenant_id_in_request SKIPPED [ 31%]
tests/test_jwt_template_validation.py::TestJWTTemplateValidation::test_invalid_jwt_token_rejected SKIPPED [ 32%]
tests/test_jwt_template_validation.py::TestJWTClaimInjectionValidation::test_active_tenant_id_claim_present PASSED [ 32%]
tests/test_jwt_template_validation.py::TestJWTClaimInjectionValidation::test_tenant_id_alternative_claim PASSED [ 32%]
tests/test_jwt_template_validation.py::TestJWTClaimInjectionValidation::test_claim_in_metadata PASSED [ 33%]
tests/test_jwt_template_validation.py::TestJWTTemplateConfigurationWarnings::test_missing_jwt_template_configuration SKIPPED [ 33%]
tests/test_jwt_template_validation.py::TestComplianceWithSecurityReview::test_action_item_1_automated_validation PASSED [ 34%]
tests/test_jwt_template_validation.py::TestComplianceWithSecurityReview::test_action_item_2_show_error_if_missing PASSED [ 34%]
tests/test_jwt_template_validation.py::TestComplianceWithSecurityReview::test_cwe_345_verification SKIPPED [ 34%]
tests/test_jwt_token_leakage_fix.py::TestJWTTokenLeakagePrevention::test_full_jwt_payload_not_logged_in_debug PASSED [ 35%]
tests/test_jwt_token_leakage_fix.py::TestJWTTokenLeakagePrevention::test_token_preview_used_not_full_token PASSED [ 35%]
tests/test_jwt_token_leakage_fix.py::TestJWTTokenLeakagePrevention::test_sensitive_claims_not_in_debug_logs PASSED [ 35%]
tests/test_jwt_token_leakage_fix.py::TestJWTTokenLeakagePrevention::test_error_logs_dont_expose_full_token PASSED [ 36%]
tests/test_jwt_token_leakage_fix.py::TestJWTTokenLeakagePrevention::test_logging_uses_safe_attributes_only PASSED [ 36%]
tests/test_jwt_token_leakage_fix.py::TestTokenExchangePattern::test_jwt_not_passed_to_couchdb PASSED [ 37%]
tests/test_jwt_token_leakage_fix.py::TestTokenExchangePattern::test_header_replacement_removes_jwt PASSED [ 37%]
tests/test_jwt_token_leakage_fix.py::TestLoggingSecurityPractices::test_no_jwt_in_standard_logs PASSED [ 37%]
tests/test_jwt_token_leakage_fix.py::TestLoggingSecurityPractices::test_audit_log_format_safe PASSED [ 38%]
tests/test_jwt_token_leakage_fix.py::TestComplianceWithSecurityReview::test_cwe_532_mitigation_implemented PASSED [ 38%]
tests/test_jwt_token_leakage_fix.py::TestComplianceWithSecurityReview::test_better_pattern_implemented PASSED [ 39%]
tests/test_jwt_token_leakage_fix.py::TestComplianceWithSecurityReview::test_logging_never_exposes_raw_jwt PASSED [ 39%]
tests/test_legacy_app.py::TestLegacyAppSupport::test_load_legacy_apps PASSED [ 39%]
tests/test_legacy_app.py::TestLegacyAppSupport::test_access_with_legacy_app PASSED [ 40%]
tests/test_local_docs.py::TestLocalDocs::test_get_local_doc PASSED       [ 40%]
tests/test_main.py::TestProxyEndpoint::test_proxy_request_without_auth_header PASSED [ 40%]
tests/test_main.py::TestProxyEndpoint::test_proxy_request_with_invalid_token PASSED [ 41%]
tests/test_main.py::TestProxyEndpoint::test_proxy_auth_header_format_missing_bearer PASSED [ 41%]
tests/test_main.py::TestProxyEndpoint::test_proxy_with_valid_clerk_token PASSED [ 42%]
tests/test_main.py::TestHealthAndRoot::test_health_check PASSED          [ 42%]
tests/test_main.py::TestHealthAndRoot::test_root_endpoint PASSED         [ 42%]
tests/test_main.py::TestTenantEnforcement::test_extract_tenant_from_jwt PASSED [ 43%]
tests/test_main.py::TestTenantEnforcement::test_extract_tenant_missing PASSED [ 43%]
tests/test_main.py::TestTenantEnforcement::test_filter_document_for_tenant PASSED [ 43%]
tests/test_main.py::TestTenantEnforcement::test_inject_tenant_into_doc PASSED [ 44%]
tests/test_main.py::TestTenantEnforcement::test_rewrite_find_query PASSED [ 44%]
tests/test_main.py::TestTenantEnforcement::test_rewrite_bulk_docs PASSED [ 45%]
tests/test_main.py::TestTenantEnforcement::test_filter_response_documents PASSED [ 45%]
tests/test_main.py::TestClerkJWTValidation::test_clerk_jwt_validation_success PASSED [ 45%]
tests/test_main.py::TestClerkJWTValidation::test_clerk_jwt_validation_failure PASSED [ 46%]
tests/test_main.py::TestClerkJWTValidation::test_clerk_jwt_missing_issuer PASSED [ 46%]
tests/test_memory_dal_apis.py::TestMemoryDALRestAPI::test_document_crud_operations PASSED [ 46%]
tests/test_memory_dal_apis.py::TestMemoryDALRestAPI::test_bulk_operations PASSED [ 47%]
tests/test_memory_dal_apis.py::TestMemoryDALRestAPI::test_find_operations PASSED [ 47%]
tests/test_memory_dal_apis.py::TestMemoryDALRestAPI::test_changes_feed PASSED [ 48%]
tests/test_memory_dal_apis.py::TestMemoryDALRestAPI::test_local_documents PASSED [ 48%]
tests/test_memory_dal_apis.py::TestMemoryDALRestAPI::test_bulk_get_operations PASSED [ 48%]
tests/test_memory_dal_apis.py::TestMemoryDALRestAPI::test_revisions_diff PASSED [ 49%]
tests/test_memory_dal_apis.py::TestMemoryDALRestAPI::test_database_info PASSED [ 49%]
tests/test_memory_dal_apis.py::TestMemoryDALRestAPI::test_session_endpoint PASSED [ 50%]
tests/test_memory_dal_apis.py::TestMemoryDALRestAPI::test_thread_safety PASSED [ 50%]
tests/test_memory_dal_apis.py::TestMemoryDALRestAPI::test_memory_backend_persistence PASSED [ 50%]
tests/test_memory_dal_apis.py::TestMemoryDALRestAPI::test_error_handling PASSED [ 51%]
tests/test_memory_dal_apis.py::TestTenantIsolationWithMemoryDAL::test_tenant_field_injection_simulation PASSED [ 51%]
tests/test_memory_dal_apis.py::TestTenantIsolationWithMemoryDAL::test_cross_tenant_data_isolation PASSED [ 51%]
tests/test_memory_dal_apis.py::TestPerformanceAndScalability::test_large_bulk_operations PASSED [ 52%]
tests/test_memory_dal_apis.py::TestPerformanceAndScalability::test_performance_with_find_queries PASSED [ 52%]
tests/test_network_integration.py::TestCouchDBIntegration::test_real_couchdb_connection SKIPPED [ 53%]
tests/test_network_integration.py::TestClerkAPIIntegration::test_real_clerk_api_connection PASSED [ 53%]
tests/test_network_integration.py::TestRealTimeBehavior::test_real_cache_expiration_timing PASSED [ 53%]
tests/test_rate_limiting.py::TestRateLimitingSetup::test_limiter_configured PASSED [ 54%]
tests/test_rate_limiting.py::TestRateLimitingSetup::test_app_has_limiter_state PASSED [ 54%]
tests/test_rate_limiting.py::TestRateLimitingSetup::test_rate_limit_exception_handler_exists PASSED [ 54%]
tests/test_rate_limiting.py::TestAuthEndpointRateLimits::test_choose_tenant_has_rate_limit PASSED [ 55%]
tests/test_rate_limiting.py::TestAuthEndpointRateLimits::test_my_tenants_has_rate_limit PASSED [ 55%]
tests/test_rate_limiting.py::TestRateLimitBehavior::test_rate_limit_error_handler_implementation PASSED [ 56%]
tests/test_rate_limiting.py::TestRateLimitBehavior::test_rate_limit_configuration PASSED [ 56%]
tests/test_rate_limiting.py::TestDoSPrevention::test_brute_force_prevention_choose_tenant PASSED [ 56%]
tests/test_rate_limiting.py::TestDoSPrevention::test_brute_force_prevention_my_tenants PASSED [ 57%]
tests/test_rate_limiting.py::TestRateLimitByIPAddress::test_different_ips_have_separate_limits PASSED [ 57%]
tests/test_rate_limiting.py::TestComplianceWithSecurityReview::test_cwe_770_allocation_of_resources PASSED [ 57%]
tests/test_reproduce_issue.py::TestCouchSitterVisibility::test_couch_sitter_sees_all_docs PASSED [ 58%]
tests/test_service_integration.py::TestServiceIntegration::test_full_user_authentication_flow PASSED [ 58%]
tests/test_service_integration.py::TestServiceIntegration::test_cache_integration_with_services PASSED [ 59%]
tests/test_service_integration.py::TestServiceIntegration::test_clerk_session_management_with_tenant_info PASSED [ 59%]
tests/test_service_integration.py::TestServiceIntegration::test_multi_user_isolation PASSED [ 59%]
tests/test_service_integration.py::TestServiceIntegration::test_error_handling_across_services PASSED [ 60%]
tests/test_service_integration.py::TestServiceIntegration::test_performance_with_concurrent_users PASSED [ 60%]
tests/test_service_integration.py::TestServiceIntegration::test_data_consistency_across_services PASSED [ 60%]
tests/test_service_integration.py::TestServiceIntegration::test_cache_invalidation_flow PASSED [ 61%]
tests/test_service_integration.py::TestServiceEdgeCases::test_user_with_no_tenant_data PASSED [ 61%]
tests/test_service_integration.py::TestServiceEdgeCases::test_tenant_creation_failure_rollback PASSED [ 62%]
tests/test_service_integration.py::TestServiceEdgeCases::test_concurrent_same_user_creation PASSED [ 62%]
tests/test_tenant_invitations.py::TestTokenGeneration::test_generate_token_format PASSED [ 62%]
tests/test_tenant_invitations.py::TestTokenGeneration::test_generate_different_tokens PASSED [ 63%]
tests/test_tenant_invitations.py::TestTokenGeneration::test_hash_token_deterministic PASSED [ 63%]
tests/test_tenant_invitations.py::TestTokenGeneration::test_hash_different_tokens_different_hashes PASSED [ 64%]
tests/test_tenant_invitations.py::TestTokenGeneration::test_verify_token_timing_attack_resistant PASSED [ 64%]
tests/test_tenant_invitations.py::TestInvitationService::test_create_invitation_returns_doc_with_token PASSED [ 64%]
tests/test_tenant_invitations.py::TestInvitationService::test_validate_token_returns_valid_invitation PASSED [ 65%]
tests/test_tenant_invitations.py::TestInvitationService::test_validate_token_rejects_expired PASSED [ 65%]
tests/test_tenant_invitations.py::TestInvitationService::test_validate_token_rejects_accepted PASSED [ 65%]
tests/test_tenant_invitations.py::TestInvitationService::test_validate_token_rejects_revoked PASSED [ 66%]
tests/test_tenant_invitations.py::TestInvitationService::test_validate_token_invalid_format PASSED [ 66%]
tests/test_tenant_invitations.py::TestTenantManagement::test_create_workspace_tenant PASSED [ 67%]
tests/test_tenant_invitations.py::TestTenantManagement::test_get_tenant PASSED [ 67%]
tests/test_tenant_invitations.py::TestTenantManagement::test_get_tenant_not_found PASSED [ 67%]
tests/test_tenant_invitations.py::TestTenantManagement::test_add_user_to_tenant PASSED [ 68%]
tests/test_tenant_invitations.py::TestInvitationFlow::test_complete_invitation_flow PASSED [ 68%]
tests/test_tenant_invitations.py::TestWorkspaceCreationAndInvitation::test_create_workspace_and_invite PASSED [ 68%]
tests/test_tenant_invitations.py::TestSecurityConstraints::test_cannot_invite_to_personal_tenant PASSED [ 69%]
tests/test_tenant_invitations.py::TestSecurityConstraints::test_owner_cannot_be_removed PASSED [ 69%]
tests/test_tenant_invitations.py::TestSecurityConstraints::test_owner_role_cannot_change PASSED [ 70%]
tests/test_tenant_invitations.py::TestSecurityConstraints::test_token_not_returned_after_initial_creation PASSED [ 70%]
tests/test_tenant_invitations.py::TestRoleBasedAccess::test_owner_permissions PASSED [ 70%]
tests/test_tenant_invitations.py::TestRoleBasedAccess::test_admin_permissions PASSED [ 71%]
tests/test_tenant_invitations.py::TestRoleBasedAccess::test_member_permissions PASSED [ 71%]
tests/test_tenant_invitations.py::TestTokenExpiration::test_token_expires_after_7_days PASSED [ 71%]
tests/test_tenant_invitations.py::TestTimingAttackResistance::test_hmac_compare_digest_used PASSED [ 72%]
tests/test_user_tenant_cache.py::TestUserTenantInfo::test_user_tenant_info_creation PASSED [ 72%]
tests/test_user_tenant_cache.py::TestUserTenantInfo::test_user_tenant_info_defaults PASSED [ 73%]
tests/test_user_tenant_cache.py::TestUserTenantInfo::test_user_tenant_info_post_init PASSED [ 73%]
tests/test_user_tenant_cache.py::TestUserTenantInfo::test_user_tenant_info_preserves_cached_at PASSED [ 73%]
tests/test_user_tenant_cache.py::TestUserTenantCache::test_cache_initialization PASSED [ 74%]
tests/test_user_tenant_cache.py::TestUserTenantCache::test_cache_default_ttl PASSED [ 74%]
tests/test_user_tenant_cache.py::TestUserTenantCache::test_set_and_get_user PASSED [ 75%]
tests/test_user_tenant_cache.py::TestUserTenantCache::test_get_nonexistent_user PASSED [ 75%]
tests/test_user_tenant_cache.py::TestUserTenantCache::test_get_expired_user PASSED [ 75%]
tests/test_user_tenant_cache.py::TestUserTenantCache::test_set_updates_cached_at PASSED [ 76%]
tests/test_user_tenant_cache.py::TestUserTenantCache::test_invalidate_user PASSED [ 76%]
tests/test_user_tenant_cache.py::TestUserTenantCache::test_invalidate_nonexistent_user PASSED [ 76%]
tests/test_user_tenant_cache.py::TestUserTenantCache::test_clear_all PASSED [ 77%]
tests/test_user_tenant_cache.py::TestUserTenantCache::test_get_stats PASSED [ 77%]
tests/test_user_tenant_cache.py::TestUserTenantCache::test_cleanup_expired_entries PASSED [ 78%]
tests/test_user_tenant_cache.py::TestUserTenantCache::test_thread_safety_concurrent_access PASSED [ 78%]
tests/test_user_tenant_cache.py::TestUserTenantCache::test_thread_safety_mixed_operations PASSED [ 78%]
tests/test_user_tenant_cache.py::TestUserTenantCache::test_cache_isolation PASSED [ 79%]
tests/test_user_tenant_cache.py::TestUserTenantCacheGlobal::test_get_cache_singleton PASSED [ 79%]
tests/test_user_tenant_cache.py::TestUserTenantCacheGlobal::test_get_cache_with_custom_ttl PASSED [ 79%]
tests/test_user_tenant_cache.py::TestUserTenantCacheGlobal::test_get_cache_default_ttl PASSED [ 80%]
tests/test_user_tenant_cache.py::TestUserTenantCacheGlobal::test_reset_cache PASSED [ 80%]
tests/test_user_tenant_cache.py::TestUserTenantCacheGlobal::test_get_cache_thread_safety PASSED [ 81%]
tests/test_user_tenant_cache.py::TestUserTenantCacheIntegration::test_cache_with_service_simulation PASSED [ 81%]
tests/test_user_tenant_cache.py::TestUserTenantCacheIntegration::test_cache_performance_with_large_dataset PASSED [ 81%]
tests/test_user_tenant_cache.py::TestUserTenantCacheIntegration::test_cache_memory_usage PASSED [ 82%]
tests/test_user_tenant_cache.py::TestUserTenantCacheIntegration::test_cache_ttl_behavior PASSED [ 82%]
tests/test_user_tenant_cache.py::TestUserTenantCacheIntegration::test_cache_edge_cases PASSED [ 82%]
tests/test_virtual_tables.py::TestVirtualTableMapper::test_user_virtual_to_internal PASSED [ 83%]
tests/test_virtual_tables.py::TestVirtualTableMapper::test_user_internal_to_virtual PASSED [ 83%]
tests/test_virtual_tables.py::TestVirtualTableMapper::test_user_id_roundtrip PASSED [ 84%]
tests/test_virtual_tables.py::TestVirtualTableMapper::test_tenant_virtual_to_internal PASSED [ 84%]
tests/test_virtual_tables.py::TestVirtualTableMapper::test_tenant_internal_to_virtual PASSED [ 84%]
tests/test_virtual_tables.py::TestVirtualTableMapper::test_tenant_id_roundtrip PASSED [ 85%]
tests/test_virtual_tables.py::TestVirtualTableAccessControl::test_user_can_read_own_doc PASSED [ 85%]
tests/test_virtual_tables.py::TestVirtualTableAccessControl::test_user_cannot_read_other_doc PASSED [ 85%]
tests/test_virtual_tables.py::TestVirtualTableAccessControl::test_user_can_update_allowed_field PASSED [ 86%]
tests/test_virtual_tables.py::TestVirtualTableAccessControl::test_user_cannot_update_immutable_field PASSED [ 86%]
tests/test_virtual_tables.py::TestVirtualTableAccessControl::test_user_cannot_update_other_user PASSED [ 87%]
tests/test_virtual_tables.py::TestVirtualTableAccessControl::test_user_cannot_delete_self PASSED [ 87%]
tests/test_virtual_tables.py::TestVirtualTableAccessControl::test_user_can_delete_other PASSED [ 87%]
tests/test_virtual_tables.py::TestVirtualTableAccessControl::test_user_can_read_tenant_if_member PASSED [ 88%]
tests/test_virtual_tables.py::TestVirtualTableAccessControl::test_user_can_update_tenant_if_owner PASSED [ 88%]
tests/test_virtual_tables.py::TestVirtualTableAccessControl::test_user_can_delete_tenant_if_owner PASSED [ 89%]
tests/test_virtual_tables.py::TestVirtualTableValidator::test_immutable_user_fields PASSED [ 89%]
tests/test_virtual_tables.py::TestVirtualTableValidator::test_immutable_tenant_fields PASSED [ 89%]
tests/test_virtual_tables.py::TestVirtualTableValidator::test_validate_user_update_allowed_fields PASSED [ 90%]
tests/test_virtual_tables.py::TestVirtualTableValidator::test_validate_user_update_immutable_field_change PASSED [ 90%]
tests/test_virtual_tables.py::TestVirtualTableValidator::test_validate_tenant_update_allowed_fields PASSED [ 90%]
tests/test_virtual_tables.py::TestVirtualTableValidator::test_validate_tenant_update_immutable_field_change PASSED [ 91%]
tests/test_virtual_tables.py::TestVirtualTableHandlerUserCRUD::test_get_user_own_doc PASSED [ 91%]
tests/test_virtual_tables.py::TestVirtualTableHandlerUserCRUD::test_get_user_other_doc_forbidden PASSED [ 92%]
tests/test_virtual_tables.py::TestVirtualTableHandlerUserCRUD::test_update_user_allowed_fields FAILED [ 92%]
tests/test_virtual_tables.py::TestVirtualTableHandlerUserCRUD::test_update_user_immutable_field_forbidden PASSED [ 92%]
tests/test_virtual_tables.py::TestVirtualTableHandlerUserCRUD::test_delete_user_soft_delete FAILED [ 93%]
tests/test_virtual_tables.py::TestVirtualTableHandlerUserCRUD::test_delete_user_self_prevention PASSED [ 93%]
tests/test_virtual_tables.py::TestVirtualTableHandlerTenantCRUD::test_create_tenant FAILED [ 93%]
tests/test_virtual_tables.py::TestVirtualTableHandlerTenantCRUD::test_get_tenant_as_member PASSED [ 94%]
tests/test_virtual_tables.py::TestVirtualTableHandlerTenantCRUD::test_get_tenant_non_member_forbidden PASSED [ 94%]
tests/test_virtual_tables.py::TestVirtualTableHandlerTenantCRUD::test_list_tenants_filtered_to_member XFAIL [ 95%]
tests/test_virtual_tables.py::TestVirtualTableHandlerTenantCRUD::test_update_tenant_owner_only PASSED [ 95%]
tests/test_virtual_tables.py::TestVirtualTableHandlerTenantCRUD::test_delete_tenant_owner_only PASSED [ 95%]
tests/test_virtual_tables.py::TestVirtualTableHandlerTenantCRUD::test_delete_tenant_cannot_delete_active PASSED [ 96%]
tests/test_virtual_tables.py::TestBootstrapManager::test_bootstrap_creates_user_and_tenant FAILED [ 96%]
tests/test_virtual_tables.py::TestBootstrapManager::test_bootstrap_user_exists_returns_active_tenant PASSED [ 96%]
tests/test_virtual_tables.py::TestBootstrapManager::test_ensure_user_bootstrap_with_jwt PASSED [ 97%]
tests/test_virtual_tables.py::TestVirtualTableChanges::test_user_changes_filters_own_doc PASSED [ 97%]
tests/test_virtual_tables.py::TestVirtualTableChanges::test_tenant_changes_filters_membership XFAIL [ 98%]
tests/test_virtual_tables.py::TestVirtualTableBulkDocs::test_bulk_docs_users_updates PASSED [ 98%]
tests/test_virtual_tables.py::TestVirtualTableBulkDocs::test_bulk_docs_tenants_deletes FAILED [ 98%]
tests/test_virtual_tables.py::TestExtractTenantBootstrapIntegration::test_extract_tenant_roady_with_active_tenant_in_jwt PASSED [ 99%]
tests/test_virtual_tables.py::TestExtractTenantBootstrapIntegration::test_extract_tenant_roady_missing_active_tenant_triggers_bootstrap FAILED [ 99%]
tests/test_virtual_tables.py::TestExtractTenantBootstrapIntegration::test_extract_tenant_couch_sitter_ignores_bootstrap PASSED [100%]

============================== warnings summary ===============================
tests/test_service_integration.py::TestServiceIntegration::test_clerk_session_management_with_tenant_info
  C:\Users\jorge.000\AppData\Local\Programs\Python\Python313\Lib\unittest\mock.py:2247: RuntimeWarning: coroutine 'AsyncClient.aclose' was never awaited
    def __init__(self, name, parent):
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
SKIPPED [1] ..\..\mycouch\tests\test_jwt_template_validation.py:38: Requires full app context with main.py endpoints
SKIPPED [1] ..\..\mycouch\tests\test_jwt_template_validation.py:77: Requires full app context with main.py endpoints
SKIPPED [1] ..\..\mycouch\tests\test_jwt_template_validation.py:115: Requires full app context with main.py endpoints
SKIPPED [1] ..\..\mycouch\tests\test_jwt_template_validation.py:139: Requires full app context with main.py endpoints
SKIPPED [1] ..\..\mycouch\tests\test_jwt_template_validation.py:210: Requires full app context with main.py endpoints
SKIPPED [1] ..\..\mycouch\tests\test_jwt_template_validation.py:278: Requires full app context with main.py endpoints
SKIPPED [1] ..\..\mycouch\tests\test_network_integration.py:33: CouchDB not available for integration testing
XFAIL tests/test_virtual_tables.py::TestVirtualTableHandlerTenantCRUD::test_list_tenants_filtered_to_member - Memory DAL $elemMatch operator needs refinement
XFAIL tests/test_virtual_tables.py::TestVirtualTableChanges::test_tenant_changes_filters_membership - Memory DAL $elemMatch operator needs refinement
FAILED tests/test_virtual_tables.py::TestVirtualTableHandlerUserCRUD::test_update_user_allowed_fields
FAILED tests/test_virtual_tables.py::TestVirtualTableHandlerUserCRUD::test_delete_user_soft_delete
FAILED tests/test_virtual_tables.py::TestVirtualTableHandlerTenantCRUD::test_create_tenant
FAILED tests/test_virtual_tables.py::TestBootstrapManager::test_bootstrap_creates_user_and_tenant
FAILED tests/test_virtual_tables.py::TestVirtualTableBulkDocs::test_bulk_docs_tenants_deletes
FAILED tests/test_virtual_tables.py::TestExtractTenantBootstrapIntegration::test_extract_tenant_roady_missing_active_tenant_triggers_bootstrap
= 6 failed, 249 passed, 7 skipped, 2 xfailed, 1 warning in 102.78s (0:01:42) ==
